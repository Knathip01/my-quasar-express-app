<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Longan Map - Northern Thailand</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    #map {
      height: 500px;
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-900">
  <div class="min-h-screen flex flex-col items-center p-4 lg:p-8">
    <div class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 lg:p-8 space-y-6">
      <header class="flex flex-col gap-2 border-b pb-4 mb-4">
        <h1 class="text-2xl lg:text-3xl font-bold text-emerald-700">
          แผนที่ราคาลำไย ภาคเหนือของประเทศไทย
        </h1>
        <p class="text-sm text-slate-600">
          พัฒนาโดยใช้ <span class="font-semibold">HTML, JavaScript, TailwindCSS, Leaflet.js, OpenStreetMap, Nominatim</span><br/>
          Label ตัวอย่าง: <span class="font-semibold">คณาธิป ศะศิบุตร์ 6604101310</span>
        </p>
      </header>

      <!-- ส่วน Map -->
      <div id="map" class="w-full rounded-xl overflow-hidden border border-slate-200"></div>

      <!-- ฟอร์มเพิ่มจุดใหม่ -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
        <!-- ฟอร์ม -->
        <form id="marker-form" class="lg:col-span-1 space-y-4 bg-slate-50 border border-slate-200 rounded-xl p-4">
          <h2 class="text-lg font-semibold text-emerald-700">
            เพิ่ม/กำหนดจุดใหม่ (New Marker)
          </h2>

          <div>
            <label class="block text-sm font-medium mb-1">Province (จังหวัด)</label>
            <input
              type="text"
              id="province"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="เช่น เชียงใหม่"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Place (สถานที่)</label>
            <input
              type="text"
              id="place"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="เช่น ตลาดสันทราย"
            />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">Price (บาท/กก.)</label>
              <input
                type="number"
                id="price"
                step="0.01"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
                placeholder="เช่น 35.50"
                required
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Date (วันที่)</label>
              <input
                type="date"
                id="date"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
                required
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1">Latitude (ถ้าอยากกำหนดเอง)</label>
              <input
                type="number"
                id="lat"
                step="0.0001"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-400"
                placeholder="18.8056"
              />
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Longitude (ถ้าอยากกำหนดเอง)</label>
              <input
                type="number"
                id="lng"
                step="0.0001"
                class="w-full rounded-lg border border-slate-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-400"
                placeholder="99.0105"
              />
            </div>
          </div>

          <p class="text-[11px] text-slate-500">
            • ถ้าใส่ Latitude/Longitude ระบบจะใช้พิกัดนั้นตรงๆ<br/>
            • ถ้าไม่ใส่พิกัด ระบบจะใช้ Geocoding จาก Nominatim โดยใช้ Province + Place
          </p>

          <button
            type="submit"
            class="w-full inline-flex items-center justify-center rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold py-2.5 mt-2 transition"
          >
            เพิ่มจุดบนแผนที่ (Add Marker)
          </button>
        </form>

        <!-- รายการจุด -->
        <div class="lg:col-span-2 space-y-3">
          <h2 class="text-lg font-semibold text-emerald-700">
            รายการจุดที่แสดงบนแผนที่ (Markers)
          </h2>
          <div
            id="marker-list"
            class="max-h-80 overflow-y-auto space-y-2 text-sm bg-slate-50 border border-slate-200 rounded-xl p-3"
          >
            <!-- เติมด้วย JavaScript -->
          </div>
          <button
            id="fit-all"
            class="mt-2 text-xs px-3 py-1.5 rounded-full border border-emerald-400 text-emerald-700 hover:bg-emerald-50"
          >
            ปรับแผนที่ให้เห็นทุกจุด (Fit All Markers)
          </button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==========================
    // Config
    // ==========================
    const GEO_CACHE_KEY = "longan_geo_cache_v1";
    const MARKERS_KEY = "longan_markers_v1";

    const northernCenter = [18.7883, 98.9853]; // เชียงใหม่
    const initialZoom = 8; // Whole Northern Region

    // ==========================
    // Load cache from LocalStorage
    // ==========================
    let geoCache = {};
    let markerData = [];

    try {
      const cacheStr = localStorage.getItem(GEO_CACHE_KEY);
      if (cacheStr) geoCache = JSON.parse(cacheStr);

      const markersStr = localStorage.getItem(MARKERS_KEY);
      if (markersStr) markerData = JSON.parse(markersStr);
    } catch (e) {
      console.warn("Cannot parse localStorage cache", e);
    }

    // ==========================
    // Init Leaflet Map
    // ==========================
    const map = L.map("map").setView(northernCenter, initialZoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Green marker icon
    const greenIcon = L.icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const leafletMarkers = []; // เก็บตัว L.Marker สำหรับ fitBounds

    // ==========================
    // Helper: Save to LocalStorage
    // ==========================
    function saveState() {
      localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
      localStorage.setItem(MARKERS_KEY, JSON.stringify(markerData));
    }

    // ==========================
    // Create Popup HTML
    // ==========================
    function buildPopupText(entry) {
      // entry: { province, place, price, date, lat, lng, label? }
      const placeText = entry.place ? entry.place + "-" + entry.province : entry.province;
      const labelText = entry.label ? `<br/><span style="font-size:11px;color:#64748b;">${entry.label}</span>` : "";
      return `${placeText} | ราคา ${entry.price} บาท | วันที่ ${entry.date}${labelText}`;
    }

    // ==========================
    // Render Marker List (ด้านขวา)
    // ==========================
    function renderMarkerList() {
      const listEl = document.getElementById("marker-list");
      listEl.innerHTML = "";
      if (markerData.length === 0) {
        listEl.innerHTML =
          '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลจุดบนแผนที่</p>';
        return;
      }

      markerData.forEach((m, idx) => {
        const div = document.createElement("div");
        div.className =
          "flex items-start justify-between gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2";
        div.innerHTML = `
          <div>
            <div class="font-semibold text-slate-800 text-xs">
              ${m.place ? m.place + " - " + m.province : m.province}
            </div>
            <div class="text-[11px] text-slate-600">
              ราคา: ${m.price} บาท/กก. | วันที่: ${m.date}
            </div>
            <div class="text-[11px] text-slate-400">
              Lat: ${m.lat.toFixed(4)}, Lng: ${m.lng.toFixed(4)}
            </div>
          </div>
          <button
            data-idx="${idx}"
            class="text-[11px] text-emerald-700 hover:text-emerald-900 underline"
          >
            Focus
          </button>
        `;
        listEl.appendChild(div);
      });

      // ปุ่ม Focus แต่ละอัน
      listEl.querySelectorAll("button[data-idx]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.dataset.idx, 10);
          const m = markerData[i];
          map.setView([m.lat, m.lng], 13);
        });
      });
    }

    // ==========================
    // Fit all markers
    // ==========================
    function fitAllMarkers() {
      if (leafletMarkers.length === 0) {
        map.setView(northernCenter, initialZoom);
        return;
      }
      const bounds = L.latLngBounds(leafletMarkers.map((m) => m.getLatLng()));
      map.fitBounds(bounds, { padding: [20, 20] });
    }

    // ==========================
    // Add marker to map + data
    // ==========================
    function addMarker(entry, skipSave) {
      markerData.push(entry);

      const marker = L.marker([entry.lat, entry.lng], { icon: greenIcon }).addTo(map);
      marker.bindPopup(buildPopupText(entry));
      leafletMarkers.push(marker);

      // onClick popup จะอ่านข้อมูลล่าสุดจาก entry ใน markerData (ถ้ามีการแก้ไขในอนาคต)
      marker.on("click", () => {
        marker.setPopupContent(buildPopupText(entry)).openPopup();
      });

      renderMarkerList();
      if (!skipSave) {
        saveState();
      }
    }

    // ==========================
    // Geocoding with Nominatim + Cache
    // ==========================
    async function geocodePlace(province, place) {
      const key = (province + "|" + (place || "")).trim().toLowerCase();
      if (geoCache[key]) {
        return geoCache[key]; // {lat, lng}
      }

      const qParts = [];
      if (place) qParts.push(place);
      if (province) qParts.push(province);
      qParts.push("ภาคเหนือ ประเทศไทย");
      const q = encodeURIComponent(qParts.join(", "));

      const url =
        "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + q;

      const res = await fetch(url, {
        headers: {
          "Accept-Language": "th"
        }
      });
      const data = await res.json();

      if (!data || data.length === 0) {
        throw new Error("ไม่พบพิกัดจาก Nominatim");
      }

      const lat = parseFloat(data[0].lat);
      const lng = parseFloat(data[0].lon);

      geoCache[key] = { lat, lng };
      saveState();

      return { lat, lng };
    }

    // ==========================
    // Initial Data (Example)
    // ==========================
    if (markerData.length === 0) {
      // 9.1) ตัวอย่างเชียงใหม่
      addMarker(
        {
       
          label: "คณาธิป ศะศิบุตร์ 6604101310"
        },
        true
      );

      // 9.2) ตัวอย่างตลาดสันทราย-เชียงใหม่
      addMarker(
        {
          province: "เชียงใหม่",
          place: "ตลาดสันทราย",
          price: 35.5,
          date: "2023-08-15",
          lat: 18.8056,
          lng: 99.0105,
          label: ""
        },
        true
      );

      saveState();
    } else {
      // ถ้ามีใน LocalStorage อยู่แล้ว ก็เอามาวาดใหม่
      markerData.forEach((entry) => addMarker(entry, true));
    }

    fitAllMarkers();
    renderMarkerList();

    // ==========================
    // Form submit
    // ==========================
    const form = document.getElementById("marker-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const province = document.getElementById("province").value.trim();
      const place = document.getElementById("place").value.trim();
      const price = parseFloat(document.getElementById("price").value);
      const date = document.getElementById("date").value;
      const latStr = document.getElementById("lat").value.trim();
      const lngStr = document.getElementById("lng").value.trim();

      if (!province || !price || !date) {
        alert("กรุณากรอก Province, Price, Date ให้ครบ");
        return;
      }

      let lat, lng;

      try {
        // ถ้ากรอก Lat/Lng เอง
        if (latStr && lngStr) {
          lat = parseFloat(latStr);
          lng = parseFloat(lngStr);
        } else {
          // ใช้ Geocoding
          const geo = await geocodePlace(province, place);
          lat = geo.lat;
          lng = geo.lng;
        }

        const entry = {
          province,
          place,
          price,
          date,
          lat,
          lng,
          label: "" // จุดใหม่ยังไม่ติด label ชื่อนศ.
        };

        addMarker(entry);
        fitAllMarkers();
        form.reset();
      } catch (err) {
        console.error(err);
        alert("ไม่สามารถแปลงชื่อสถานที่เป็นพิกัดได้ (Geocoding error)");
      }
    });

    // ปุ่ม Fit All
    document.getElementById("fit-all").addEventListener("click", () => {
      fitAllMarkers();
    });
  </script>
</body>
